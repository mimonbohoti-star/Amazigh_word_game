<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title> âµ£Ù„Ø¹Ø¨Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ùˆ Ø§Ù„Ø£Ù„ØºØ§Ø² Ø§Ù„Ø£Ù…Ø§Ø²ÙŠØºÙŠØ©âµ£</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link
 href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--accent:#f0eae2} 
*{box-sizing:border-box}
#mapStageBackground {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: url('path/to/your/image.jpg'); /* Ø¶Ø¹ Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§ */
  background-size: cover;      /* ÙŠØºØ·ÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
  background-position: center;
  background-repeat: no-repeat;
  z-index: 0;
  pointer-events: none;
  opacity: 0.4;
}

#map .card, #map h1, #map #mapGrid, #map button {
  position: relative; /* Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙˆÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© */
  z-index: 1;
}
/*===== BODY & BACKGROUND ===== */

body {
  margin: 0;
  font-family: 'Noto Sans Arabic', system-ui, sans-serif;
  color: #ff8c00;

  height: 100vh;           /* Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
  overflow: hidden;        /* Ù„Ø§ ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ */
  
  /* Ø®Ù„ÙÙŠØ© Ù…ØªØ¯Ø±Ø¬Ø© Ù…ØªØ­Ø±ÙƒØ© */
  background: linear-gradient(180deg, #0055A4 0%, #FFD700 50%, #008A00 100%);
  background-size: 200% 200%;
  animation: bgMove 20s linear infinite, bgColorShift 40s ease-in-out infinite alternate;
}

.question {
  font-size: 16px;
  line-height: 1.7;
  font-weight: 600;
  text-align: center;
}

/* ===== Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø®Ù„ÙÙŠØ© ===== */
@keyframes bgMove {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

@keyframes bgColorShift {
  0%   { background: linear-gradient(180deg, #0055A4 0%, #FFD700 50%, #008A00 100%); }
  25%  { background: linear-gradient(180deg, #0060B0 0%, #FFDE00 50%, #009000 100%); }
  50%  { background: linear-gradient(180deg, #004C99 0%, #FFCC00 50%, #007700 100%); }
  75%  { background: linear-gradient(180deg, #0055A4 0%, #FFD700 50%, #008A00 100%); }
  100% { background: linear-gradient(180deg, #0055A4 0%, #FFD700 50%, #008A00 100%); }
}

/* ===== Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© ===== */
.secondary-btn {
  background: transparent;
  border: 2px solid var(--accent);
  color: var(--accent);
  padding: 10px 16px;
  border-radius: 14px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 10px;
}

/* ===== Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Overlay ===== */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.65);
  z-index: 20;
  display: flex;
  align-items: center;
  justify-content: center;
}

.overlay-content {
  background: #000;
  border-radius: 20px;
  padding: 20px;
  width: 90%;
  max-width: 380px;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 0 0 2px var(--accent);
}

.overlay-content h2 {
  text-align: center;
  color: var(--accent);
  margin-bottom: 10px;
}

.overlay-content p,
.overlay-content li {
  font-size: 16px;
  line-height: 1.6;
}

.overlay-content ul {
  padding-inline-start: 18px;
}

.note {
  margin-top: 12px;
  font-size: 14px;
  opacity: .7;
  text-align: center;
}

/* ===== Ø­Ø±ÙˆÙ Ø£Ù…Ø§Ø²ÙŠØºÙŠØ© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© ===== */
body::before {
  content: '';
  position: fixed; /* Ø«Ø§Ø¨Øª Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© */
  top: 0; left: 0;
  width: 200%; height: 200%;
  background: transparent url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12">\
<text x="0" y="12" font-size="12" fill="white">âµ£â´³â´·â´¹âµ‹</text>\
</svg>') repeat;
  background-size: 40px 40px;
  animation: lettersMove 60s linear infinite;
  pointer-events: none;
  z-index: 0;
  opacity: 0.5;
}

@keyframes lettersMove {
  0% { transform: translate(0,0); }
  100% { transform: translate(-50%, -50%); }
}

/* ===== Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ===== */
.card {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);

  width: 90%;
  max-width: 560px;

  height: auto;          /* Ø¨Ø¯Ù„ height: 80vh; */
  min-height: 50vh;      /* Ø£Ù‚Ù„ Ø§Ø±ØªÙØ§Ø¹ Ù…Ù…ÙƒÙ† */
  max-height: 90vh;      /* Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² 90% Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© */

  padding: 22px;
  border-radius: 26px;
  background: linear-gradient(to bottom, #0000ff, #008000, #ffff00);

  display: flex;
  flex-direction: column;

  overflow-y: auto;      /* ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙÙ‚Ø· */
  overflow-x: hidden;

  z-index: 10;
}

/* ===== ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ===== */
#questionImg {
  width: 100%;          /* ØªØºØ·ÙŠ ÙƒØ§Ù…Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
  height: auto;
  max-height: 260px;    /* Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² 40% Ù…Ù† Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
  object-fit: contain;   /* ØªØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */
  border-radius: 16px;   /* Ø­ÙˆØ§Ù Ù†Ø§Ø¹Ù…Ø© */
  margin-bottom: 12px;   /* Ù…Ø³Ø§ÙØ© Ø£Ø³ÙÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ */
}

/* ===== Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ===== */
.stage-key {
  position: relative;        /* Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„Ù‚ÙÙ„ */
  flex: 0 0 200px;
  min-width: 250px;
  height: 350px;

  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start; /* Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
  padding: 6px;

  border-radius: 14px;
  background: #1e293b;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  scroll-snap-align: start;
}

/* ===== Ø§Ù„Ø´Ø¨ÙƒØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ===== */

.stage-grid {
  display: grid;
  gap: 1px;

  width: 95%;          /* ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ ØªØºØ·ÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
  max-width: 260px;    /* Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø´Ø¨ÙƒØ© */
  margin: 6px auto;    /* ØªÙˆØ³ÙŠØ· Ø§Ù„Ø´Ø¨ÙƒØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */

  /* Ù†Ø¶Ù…Ù† Ø£Ù† Ø§Ù„ØµÙÙˆÙ ØªØªÙƒÙŠÙ Ø¨Ø´ÙƒÙ„ Ù…ØªØ³Ø§ÙˆÙŠ */
  grid-auto-rows: 1fr;

  /* Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§Ø±ØªÙØ§Ø¹ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
  max-height: 180px;   
}

.stage-grid .cell {
  background: #FFA500;
  border-radius: 4px;

  display: flex;
  align-items: center;
  justify-content: center;

  font-weight: bold;
  font-size: clamp(10px, 2vw, 16px);

  /* Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ù†Ø© Ù…Ø±Ø¨Ø¹Ø© */
  aspect-ratio: 1 / 1;

  width: 100%;
  height: 100%;
}
.stage-key.locked {
  opacity: .35;
  pointer-events: none;
}

.stage-key.locked::after {
  content: "ğŸ”’";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 26px;
}

/* ===== SECTIONS ===== */
.section{
 display:none;
 opacity:0;
 transform:translateY(16px) scale(.97);
 pointer-events:none;
 transition: opacity .35s ease, transform .35s cubic-bezier(.4,0,.2,1);
}
.section.active{
 display:block;
 opacity:1;
 transform:translateY(0) scale(1);
 pointer-events:auto;
}

/* ===== BUTTONS ===== */
.btn{
 width:100%;min-height:52px;margin:8px 0;border:none;border-radius:16px;
 font-size:18px;font-weight:700;cursor:pointer;
 transition:all .3s ease;
}
.btn-main {
  background: linear-gradient(135deg, #0f172a, #334155); /* Ù†ÙØ³ ØªØ¯Ø±Ø¬ Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
  color: #f0eae2; /* Ø®Ø· Ø£Ø¨ÙŠØ¶ */
  border: 1px solid #334155; /* Ù†ÙØ³ Ø§Ù„Ø­Ø¯ÙˆØ¯ */
}
.btn-back{
 background:linear-gradient(135deg,#0f172a,#334155);
 color:#f0eae2;
 border:1px solid #334155;
}
.btn:hover{
 box-shadow:0 4px 15px rgba(0,0,0,0.4);
 transform:scale(1.03);
}

#game #hintBtn,
#game .btn-back {
  width: auto;
  min-height: 36px;
  padding: 6px 12px;
  font-size: 14px;
  border-radius: 12px;
}
/* ===== SETTINGS ===== */
.setting-item{
 display:flex;justify-content:space-between;align-items:center;
 background:#0f172a;border:1px solid #334155;
 border-radius:14px;padding:14px;margin:10px 0;
 font-size:18px;
}
.toggle{
 width:52px;height:28px;border-radius:20px;
 background:#334155;position:relative;cursor:pointer;
}
.toggle::after{
 content:"";position:absolute;top:4px;right:4px;
 width:20px;height:20px;border-radius:50%;
 background:#fff;transition:.3s;
}
.toggle.on{background:var(--accent)}
.toggle.on::after{right:28px}

/* ===== ANSWER BOXES ===== */
.answer-boxes{
 display:flex;justify-content:center;gap:8px;margin:12px 0;direction:ltr;
}
.answer-box{
 width:44px;height:44px;border-radius:10px;
 background:#fff;color:#000;
 display:flex;align-items:center;justify-content:center;font-size:22px;
 transition:all .3s ease;
}
.answer-box.ok{
 background:linear-gradient(135deg,#22c55e,#4ade80);
 color:#fff;
}
.answer-box.bad{
 background:linear-gradient(135deg,#ef4444,#f87171);
 color:#fff;
}
.question-text{
  display:none;
  margin:12px 0;
  font-size:18px;
  line-height:1.7;
  font-weight:600;
  text-align:center;
}
/* ===== KEYBOARD ===== */
.keyboard {
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* 4 Ø£Ø¹Ù…Ø¯Ø© Ù„ÙƒÙ„ ØµÙ */
  gap: 10px; /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø­Ø±ÙˆÙ */
}

/* ÙŠÙ…ÙƒÙ† Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ØªØ¹Ø±ÙŠÙ Ù…Ø«Ù„Ø« Ù„Ø£Ù†Ù‡ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù… */
.key{
 background:#1e293b;
 padding:14px;
 border-radius:14px;
 text-align:center;
 font-size:22px;
 font-weight:bold;
 cursor:pointer;
 touch-action:none; 
 transition:transform .08s ease, box-shadow .3s ease, background .3s ease;
}
.key.locked{
 position:relative;
 opacity:.35;
 pointer-events:none;
}
.key.locked::after{
 content:"ğŸ”’";
 position:absolute;
 inset:0;
 display:flex;
 align-items:center;
 justify-content:center;
 font-size:26px;
}
.key.used{opacity:.25;pointer-events:none}
.key.shake{
 animation:shake .3s;
}
.key:active{
 transform:scale(0.92);
 box-shadow:0 4px 10px rgba(0,0,0,0.3);
}
.key:hover:not(.locked){
 background:linear-gradient(135deg,#334155,#1e293b);
 box-shadow:0 4px 12px rgba(0,0,0,0.4);
}
@keyframes shake{
 0%{transform:translateX(0)}
 25%{transform:translateX(-4px)}
 50%{transform:translateX(4px)}
 75%{transform:translateX(-4px)}
 100%{transform:translateX(0)}
}
/* ===== HEXAGON MODE ===== */
.hexagon{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:12px;
  justify-items:center;
}

.hex-cell{
  width:64px;
  height:56px;
  background:#1e293b;
  clip-path: polygon(
    25% 0%,
    75% 0%,
    100% 50%,
    75% 100%,
    25% 100%,
    0% 50%
  );
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  font-weight:bold;
  cursor:pointer;
  transition:transform .15s ease, background .3s ease;
}

.hex-cell:active{
  transform:scale(0.9);
}

.hex-cell:hover{
  background:linear-gradient(135deg,#334155,#1e293b);
}
/* ===== WHEEL ===== */
.wheel{
 width:260px;height:260px;margin:16px auto;
 border-radius:50%;
 border:3px solid var(--accent);
 position:relative;
 background: conic-gradient(from 0deg, #facc15, #ffea00, #22c55e, #4ade80, #facc15);
 animation: wheelRotate 10s linear infinite;
}
@keyframes wheelRotate {
  0%{transform:rotate(0deg);}
  100%{transform:rotate(360deg);}
}
.wheel .key{
 width:52px;height:52px;border-radius:50%;
 background: var(--accent);
 color:#000;
 position:absolute;display:flex;align-items:center;justify-content:center;
 transition:all .3s ease, transform .2s ease;
}

.wheel .key:hover{
 transform:scale(1.2);
 box-shadow:0 6px 15px rgba(0,0,0,0.4);
}

/* ===== DELETE BUTTON ===== */
.delete{
 background:#0f172a;border:1px solid #334155;
 border-radius:14px;padding:14px;font-size:20px;font-weight:bold;cursor:pointer;
 transition:all .3s ease;
}
.delete:hover{
 box-shadow:0 4px 12px rgba(0,0,0,0.3);
 transform:scale(1.05);
}

/* ===== OVERLAY & WIN ===== */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.8);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.overlay.active{display:flex}
.win{
 background:#020617;padding:26px;border-radius:22px;
 box-shadow:0 0 60px var(--accent);text-align:center;
}

/* ===== CONFETTI ===== */
.confetti{
 position:fixed;
 top:-20px;
 font-size:26px;
 animation:fall linear forwards;
 pointer-events:none;
 z-index:2000; /* ÙÙˆÙ‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ù„Ù€ overlay */
 color: #facc15;
}
.confetti:nth-child(odd){color:#22c55e;}
.confetti:nth-child(even){color:#ff4444;}
@keyframes fall{
 to{
  transform:translateY(120vh) rotate(720deg) rotateX(360deg);
  opacity:0;
 }
}
#finalOverlay .win{
  width:90%;
  max-width:420px;
  padding:36px;
  border-radius:26px;
  box-shadow:0 0 120px var(--accent);
  animation:finalPop .6s ease-out;
}

@keyframes finalPop{
  from{
    transform:scale(.6);
    opacity:0;
  }
  to{
    transform:scale(1);
    opacity:1;
  }
}

/* ===== MAP GRID SCROLL & SNAP ===== */

/* ===== MAP GRID ===== */
#mapGrid {
  display: flex;
  flex-direction: row;
  gap: 12px;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  padding: 10px;
  min-width: 0; /* Ù…Ù‡Ù… Ù„ØªØ¬Ù†Ø¨ Ù…Ø´ÙƒÙ„Ø© Flexbox Ø¹Ù„Ù‰ Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª */
}

.stage-key {
  flex: 0 0 200px; /* ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ… */
  min-width: 150px; /* ÙŠØ¶Ù…Ù† Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ */
}

/* ===== BACKGROUND ===== */
#stageBackground {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  z-index: -1; /* ØªØ­Øª ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
  pointer-events: none; /* Ù„Ø§ ØªØªØ¯Ø§Ø®Ù„ Ù…Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
  opacity: 0.4; /* ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙØ§ÙÙŠØ© */
}

/* ===== STAGE GRID ===== */
.stage-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); /* Ø£Ø¹Ù…Ø¯Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© */
  grid-auto-rows: 80px; /* Ø§Ø±ØªÙØ§Ø¹ ÙƒÙ„ Ø®Ù„ÙŠØ© */
  gap: 6px; /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª */
  width: 100%;
  max-width: 400px;
  margin: 10px auto 12px auto; /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ§Ù„Ø£Ø³ÙÙ„ */
}

/* ===== STAGE CELL ===== */
.stage-grid .cell {
  background: #1e293b;
  border-radius: 6px;
  border: 1px solid #334155;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 22px;
  color: #fff;
user-select: none;
}

</style>
</head>

<body>
<div id="mapBackground"></div>
<div class="card">
<div id="menu" class="section active">
 <h1>âµ£Ù„Ø¹Ø¨Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ùˆ Ø§Ù„Ø£Ù„ØºØ§Ø² Ø§Ù„Ø£Ù…Ø§Ø²ÙŠØºÙŠØ©âµ£</h1>
 <button class="btn btn-main" onclick="openMap()">â–¶ï¸ â´±â´·â´°</button>

 <button class="btn btn-back" onclick="show('settings')">ğŸ”§ settings</button>
<button class="secondary-btn" onclick="openHowTo()">â„¹ ÙƒÙŠÙÙŠØ© Ø§Ù„Ù„Ø¹Ø¨</button>
</div>
<div id="settings" class="section">
 <h1>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h1>

 <div class="setting-item">
 <span id="soundLabel">ğŸ”Š Ø§Ù„ØµÙˆØª</span>
  <div id="soundToggle" class="toggle"></div>
 </div>

<div class="setting-item">
 <span id="vibeLabel">ğŸ“³ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²</span>
  <div id="vibeToggle" class="toggle"></div>
</div>
<div class="setting-item">
  <span>ğŸŒ Ø§Ù„Ù„ØºØ©</span>
  <select onchange="setLang(this.value)">
    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
    <option value="en">English</option>
    <option value="am">âµœâ´°âµâ´°âµ£âµ‰âµ–âµœ</option>
  </select>
</div>
 <button class="btn btn-back" onclick="show('menu')">â†</button>  
</div>  
<div class="map-container">
<div id="map" class="section">  
  <div id="mapStageBackground"></div> <!-- Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø±Ø§Ø­Ù„ -->
  <h1>â­ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</h1>  
  <div id="mapGrid"></div>
  <button class="btn btn-back" onclick="show('menu')">â†</button>
</div>
<div id="game" class="section">

<div id="stageBackground"></div>
 <h1 id="levelTitle"></h1>
<img id="questionImg" src="path/to/your/image.jpg" alt="Ø§Ù„Ø³Ø¤Ø§Ù„">

<div id="questionText" class="question-text"></div>
 <!-- ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© -->
 <div class="answer-boxes" id="boxes"></div>

 <!-- Ø²Ø± Ø§Ù„ØªÙ„Ù…ÙŠØ­ ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯ -->
 <button class="btn btn-back" id="hintBtn">ğŸ’¡</button>
 <div id="hintCount">3</div>

 <!-- Ø¹Ø¬Ù„Ø© Ø§Ù„Ø£Ø­Ø±Ù -->
 <div id="wheel" class="wheel"></div>

 <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ -->
 <div id="keyboard" class="keyboard"></div>

 <!-- Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø®Ø±ÙŠØ·Ø© -->
 <button class="btn btn-back" onclick="show('map')">â†</button>
</div>

<div id="overlay" class="overlay">
 <div class="win"><h2>ğŸ”¥ Ø£Ø­Ø³Ù†Øª ğŸ”¥</h2></div>
</div>
<div id="finalOverlay" class="overlay">
 <div class="win">
  <h2>ğŸ† Ù…Ø¨Ø±ÙˆÙƒ! ğŸ†</h2>
  <p>Ø£Ù†Ù‡ÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø¨Ù†Ø¬Ø§Ø­</p>
  <button class="btn btn-main" onclick="finalOverlay.classList.remove('active'); show('menu');">ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
</div>
</div>
<div id="stageOverlay" class="overlay">
 <div class="win">
  <h2>âœ¨ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø±Ø­Ù„Ø© âœ¨</h2>
  <div id="starsView" style="font-size:32px;margin:12px 0"></div>
  <button class="btn btn-main" id="nextStageBtn">â–¶ï¸ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©</button>
  <button class="btn btn-back" onclick="show('map'); stageOverlay.classList.remove('active')">ğŸ—ºï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
 </div>
</div>
<div id="howToBox" class="overlay" style="display:none">
  <div class="overlay-content">
    <h2>ÙƒÙŠÙÙŠØ© Ø§Ù„Ù„Ø¹Ø¨ How to Play </h2>

    <p>
This Amazigh words and puzzles game aims to test your knowledge and enrich your vocabulary in a fun way.
      Ù‡Ø°Ù‡ Ù„Ø¹Ø¨Ø© ÙƒÙ„Ù…Ø§Øª ÙˆØ£Ù„ØºØ§Ø² Ø£Ù…Ø§Ø²ÙŠØºÙŠØ© ØªÙ‡Ø¯Ù Ø¥Ù„Ù‰ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ
      ÙˆØªÙ†Ù…ÙŠØ© Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ù„ØºÙˆÙŠ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ù…ØªØ¹Ø©.

    </p>

    <ul>
      <li>Read the question or look at the image carefully.
</li>
<li>Ø§Ù‚Ø±Ø£ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø£Ùˆ Ø´Ø§Ù‡Ø¯ Ø§Ù„ØµÙˆØ±Ø© Ø¬ÙŠØ¯Ù‹
</li>
      <li>Drag the letters to form the correct word. </li>
<li>Ø§Ø³Ø­Ø¨ Ø§Ù„Ø­Ø±ÙˆÙ Ù„ØªÙƒÙˆÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
</li>
      <li> Each correct answer earns you stars â­.</li>
<li>ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ØªÙ…Ù†Ø­Ùƒ Ù†Ø¬ÙˆÙ… â­.</li>
      <li>Use stars to request a hint.</li>
 <li>ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ø§Ù„Ù†Ø¬ÙˆÙ… Ù„Ø·Ù„Ø¨ ØªÙ„Ù…ÙŠØ­</li>
      <li>Your progress is saved automatically.</li>
<li>ØªÙ‚Ø¯Ù‘Ù…Ùƒ ÙŠÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</li>
</ul>
    <p class="note">
       âµ£ Beta version by Azeddin Bouhouti â€“ New Year's Competition 
âµ£ âµ£Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ø²Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø¨Ø­ÙˆØªÙŠ â€“ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø±Ø£Ø³ Ø§Ù„Ø³Ù†Ø© âµ£
    </p>

    <button 
onclick="closeHowTo()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
<script>
/* ===== ÙØªØ­ ÙˆØºÙ„Ù‚ How To ===== */
function openHowTo(){ document.getElementById("howToBox").style.display="flex"; }
function closeHowTo(){ document.getElementById("howToBox").style.display="none"; }

/* ===== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ===== */
let stars = JSON.parse(localStorage.getItem("amazighStars") || "[]");
const boxes = document.getElementById("boxes");
const keyboard = document.getElementById("keyboard");
const wheel = document.getElementById("wheel");
const mapGrid = document.getElementById("mapGrid");

let isDragging = false;
let input = []; // ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
let currentLang = localStorage.getItem("lang") || "ar";
let stage = 0, q = 0, drag = false;
let hintsLeft = 3, hintsUsed = 0;
let unlocked = +localStorage.getItem("amazighUnlocked") || 0;

/* ===== SETTINGS ===== */
let soundOn = localStorage.getItem("soundOn") !== "0";
let vibeOn = localStorage.getItem("vibeOn") !== "0";
const soundToggle = document.getElementById("soundToggle");
const vibeToggle = document.getElementById("vibeToggle");

/* ===== Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© ===== */
const levelTitle = document.getElementById("levelTitle");
const questionImg = document.getElementById("questionImg");
const questionText = document.getElementById("questionText");

/* ===== Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ===== */
function saveAnswer(stageIndex, qIndex, lettersArray) {
  const saved = JSON.parse(localStorage.getItem("amazighAnswers") || "{}");
  if (!saved[stageIndex]) saved[stageIndex] = {};
  saved[stageIndex][qIndex] = lettersArray;
  localStorage.setItem("amazighAnswers", JSON.stringify(saved));
}
/* ===== Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ù…Ø¹ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ===== */
function createStageGridForCard(stageIndex) {
  const stageCard = mapGrid.children[stageIndex];
  if (!stageCard) return;

  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  const oldGrid = stageCard.querySelector('.stage-grid');
  if (oldGrid) oldGrid.remove();

  const stageData = stages[stageIndex];
  const layout = stageData.layout || [];

  // ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
  input = Array.from(boxes.querySelectorAll('.box'));

  // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ©
  const grid = document.createElement('div');
  grid.className = 'stage-grid';
  stageCard.appendChild(grid);

  const cols = Math.max(...layout.map(l => l.col + (l.dir === "horizontal" ? l.length : 1)));
  const rows = Math.max(...layout.map(l => l.row + (l.dir === "vertical" ? l.length : 1)));

  grid.style.display = "grid";
  grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
  grid.style.gap = "2px";

  const cellsMap = {};
  const savedAll = JSON.parse(localStorage.getItem("amazighAnswers") || "{}");

  // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ù„Ù€ layout ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
  layout.forEach(l => {
    for (let i = 0; i < l.length; i++) {
      const r = l.dir === "horizontal" ? l.row : l.row + i;
      const c = l.dir === "horizontal" ? l.col + i : l.col;
      const key = r + "-" + c;

      let cell;
      if (cellsMap[key]) {
        cell = cellsMap[key];
        if (!cell.dataset.q.split(",").includes(String(l.q))) {
          cell.dataset.q += "," + l.q;
        }
      } else {
        cell = document.createElement('div');
        cell.className = 'cell column-cell';
        cell.dataset.q = String(l.q);
        cell.dataset.row = r;
        cell.dataset.col = c;
        cell.dataset.pos = i;
        grid.appendChild(cell);
        cellsMap[key] = cell;

        cell.style.gridColumn = l.dir === "horizontal" ? c + 1 : l.col + 1;
        cell.style.gridRow = l.dir === "horizontal" ? l.row + 1 : r + 1;
        cell.style.border = "1px solid #aaa";
        cell.style.display = "flex";
        cell.style.alignItems = "center";
        cell.style.justifyContent = "center";
        cell.style.userSelect = "none";
        cell.style.fontWeight = "bold";
        cell.style.fontSize = "20px";
      }

      // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
      const savedLetter = savedAll?.[stageIndex]?.[l.q]?.[i];
      if (savedLetter) {
        cell.textContent = savedLetter;
        cell.dataset.letter = savedLetter;
        if (input[i]) input[i].textContent = savedLetter;
      }
    }
  });

  // ===== Ø§Ù„Ø³Ø­Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØ­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª =====
  layout.forEach(l => {
    const cells = Array.from(grid.querySelectorAll(".cell"))
      .filter(cell => cell.dataset.q.split(",").includes(String(l.q)));

    let dragging = false;

    const startDrag = () => { dragging = true; };
    const endDrag = () => { dragging = false; };

    const updateColumn = () => {
      const answerArr = stageData.answers?.[l.q] || [];
      const lettersToSave = [];

      cells.forEach((cell, idx) => {
        const letter = answerArr[idx];
        if (!letter) return;

        cell.textContent = letter;
        cell.dataset.letter = letter;

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ø±Ù ÙÙŠ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­
        const pos = parseInt(cell.dataset.pos, 10);
        if (input[pos]) input[pos].textContent = letter;

        lettersToSave.push(letter);
      });

      saveAnswer(stageIndex, l.q, lettersToSave);
      // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„
      startStage(stageIndex, l.q);
    };

    // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ù„Ù…Ø³
    cells.forEach(cell => {
      cell.onmousedown = startDrag;
      cell.onmouseover = () => { if (dragging) updateColumn(); };
      cell.ontouchstart = startDrag;
      cell.ontouchmove = e => {
        const touch = e.touches[0];
        const elem = document.elementFromPoint(touch.clientX, touch.clientY);
        if (dragging && elem && cells.includes(elem)) updateColumn();
      };
    });

    document.addEventListener("mouseup", endDrag);
    document.addEventListener("touchend", endDrag);
  });

  // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ù„Ø¡ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  layout.forEach(l => {
    const letters = savedAll?.[stageIndex]?.[l.q] || [];
    letters.forEach((letter, i) => {
      const pos = i;
      if (input[pos]) input[pos].textContent = letter;
    });
  });
}

function syncToggles(){
  soundToggle.classList.toggle("on", soundOn);
  vibeToggle.classList.toggle("on", vibeOn);
}
soundToggle.onclick = () => { soundOn = !soundOn; localStorage.setItem("soundOn", soundOn?1:0); syncToggles(); };
vibeToggle.onclick = () => { vibeOn = !vibeOn; localStorage.setItem("vibeOn", vibeOn?1:0); syncToggles(); };
syncToggles();

/* ===== ØµÙˆØª ÙˆØ¥Ù‡ØªØ²Ø§Ø² (clap) ===== */
let ctx;
function clap(){
  if(!soundOn) return;
  if(!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
  for(let i=0; i<6; i++){
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.type="square"; o.frequency.value = 200 + Math.random()*400;
    g.gain.setValueAtTime(.5, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(.01, ctx.currentTime+.15);
    o.connect(g).connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+.15);
  }
  if(vibeOn && navigator.vibrate) navigator.vibrate([80,40,80]);
}
/* ===== SHOW/HIDE SECTIONS ===== */
function show(id){
  document.querySelectorAll(".section").forEach(s => { s.classList.remove("active"); s.style.display="none"; });
  document.body.offsetHeight;
  document.getElementById("mapBackground").style.display = (id==="map")?"block":"none";
  const el = document.getElementById(id);
  el.style.display="block";
  requestAnimationFrame(()=>el.classList.add("active"));
}

/* ===== ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© ===== */
function setLang(l){
  currentLang = l;
  localStorage.setItem("lang", l);
  applyLang();
}
const translations = {
  ar:{title:"âµ£Ù„Ø¹Ø¨Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ùˆ Ø§Ù„Ø£Ù„ØºØ§Ø² Ø§Ù„Ø£Ù…Ø§Ø²ÙŠØºÙŠØ©âµ£",start:"â–¶ï¸ Ø¨Ø¯Ø¡",settings:"âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",settingsBtn:"ğŸ”§ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",howToBtn:"â„¹ ÙƒÙŠÙÙŠØ© Ø§Ù„Ù„Ø¹Ø¨",langLabel:"ğŸŒ Ø§Ù„Ù„ØºØ©",stage:"Ù…Ø±Ø­Ù„Ø©",stagesTitle:"â­ Ø§Ù„Ù…Ø±Ø§Ø­Ù„",level:"Ø§Ù„Ù…Ø±Ø­Ù„Ø©",question:"Ø³Ø¤Ø§Ù„",back:"â¬…ï¸ Ø±Ø¬ÙˆØ¹",hint:"ğŸ’¡ ØªÙ„Ù…ÙŠØ­",win:"ğŸ”¥ Ø£Ø­Ø³Ù†Øª ğŸ”¥",final:"ğŸ† Ù…Ø¨Ø±ÙˆÙƒ! ğŸ†",sound:"ğŸ”Š Ø§Ù„ØµÙˆØª",vibe:"ğŸ“³ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²"},
  en:{title:"âµ£ Amazigh Word Game âµ£",start:"â–¶ï¸ Start",settings:"âš™ï¸ Settings",settingsBtn:"ğŸ”§ Settings",howToBtn:"â„¹ How to Play",langLabel:"ğŸŒ Language",stage:"Stage",stagesTitle:"â­ Stages",level:"Stage",question:"Question",back:"â¬…ï¸ Back",hint:"ğŸ’¡ Hint",win:"ğŸ”¥ Well done ğŸ”¥",final:"ğŸ† Congratulations! ğŸ†",sound:"ğŸ”Š Sound",vibe:"ğŸ“³ Vibration"},
  am:{title:"âµ£ âµœâ´°âµâ´°âµ£âµ‰âµ–âµœ âµ£",start:"â–¶ï¸ â´±â´·â´°",settings:"âš™ï¸ âµœâµ‰âµ™âµâµ‰âµâµ‰âµ",settingsBtn:"ğŸ”§ âµœâµ‰âµ™âµâµ‰âµâµ‰âµ",howToBtn:"â„¹ âµœâ´°âµ™â´½â´°âµ¡âµœ",langLabel:"ğŸŒ âµœâµ‰âµ™â´½âµâµ“âµ",stage:"âµ–â´°âµ”â´°",stagesTitle:"â­ âµ‰âµ–â´°âµ”â´°âµ",level:"âµ–â´°âµ”â´°",question:"âµœâµ‰âµ™â´½â´°",back:"â¬…ï¸ âµ”âµ”â´°âµŠâµ“",hint:"ğŸ’¡ âµœâ´°âµ™â´½â´°",win:"ğŸ”¥ â´°âµ¢âµ¢âµ“âµ£ ğŸ”¥",final:"ğŸ† â´°âµ¢âµ¢âµ“âµ£! ğŸ†",sound:"ğŸ”Š â´°âµ™âµ™âµ“âµ",vibe:"ğŸ“³ â´°âµâµ£âµ£âµ“âµ£"}
};
function applyLang(){
  const t = translations[currentLang];
  document.querySelector("#menu h1").textContent = t.title;
  document.querySelector("#settings h1").textContent = t.settings;
  document.querySelector(".btn-main").textContent = t.start;
  document.querySelector("button[onclick=\"show('settings')\"]").textContent = t.settingsBtn;
  document.getElementById("soundLabel").textContent = t.sound;
  document.getElementById("vibeLabel").textContent = t.vibe;
  document.querySelector(".secondary-btn").textContent = t.howToBtn;
  document.querySelector("#settings select")?.previousElementSibling && 
    (document.querySelector("#settings select").previousElementSibling.textContent = t.langLabel);
  document.querySelector("#map h1").textContent = t.stagesTitle;
  document.querySelectorAll('[data-action="back"]').forEach(btn => btn.textContent = t.back);
  document.querySelector("#overlay h2").textContent = t.win;
  document.querySelector("#stageOverlay h2").textContent = t.win;
  document.querySelector("#finalOverlay h2").textContent = t.final;
  document.querySelector("#finalOverlay button") && 
    (document.querySelector("#finalOverlay button").textContent = t.start);
  document.body.dir = (currentLang==="ar")?"rtl":"ltr";
}
applyLang();

/* ===== RENDER MAP BUTTONS ===== */
function openMap() {
  mapGrid.innerHTML = "";

  stages.forEach((stageData, i) => {
    const d = document.createElement("div");
    d.className = "stage-key" + (i > unlocked ? " locked" : "");

    // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙˆØ§Ù„Ù†Ø¬ÙˆÙ…
    const s = stars[i] || 0;
    d.innerHTML = `
      <div style="text-align:center;margin-top:4px">${translations[currentLang].stage} ${i+1}</div>
      <div style="font-size:16px;text-align:center">${"â­".repeat(s)}${"â˜†".repeat(3-s)}</div>
    `;

    mapGrid.appendChild(d);

    // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
    createStageGridForCard(i);
  });

  show("map");
}

/* ===== START STAGE ===== */
function startStage(stageIndex, questionIndex = 0){
  stage = stageIndex;
  q = questionIndex;
  hintsLeft = 3;

  // Ù„Ø§ ØªØ¹ÙŠØ¯ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ© Ù‡Ù†Ø§
  // ÙÙ‚Ø· Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
  startQuestion();
  show("game");
}

function updateStageGrid(stageIndex, questionIndex, answerArr) {
  const stageCard = mapGrid.children[stageIndex];
  if (!stageCard) return;

  const grid = stageCard.querySelector('.stage-grid');
  if (!grid) return;

  const stageData = stages[stageIndex];
  if (!stageData) return;

  const layoutItem = stageData.layout.find(l => l.q === questionIndex);
  if (!layoutItem) return;

  for (let i = 0; i < layoutItem.length; i++) {

    const r = layoutItem.dir === "horizontal"
      ? layoutItem.row
      : layoutItem.row + i;

    const c = layoutItem.dir === "horizontal"
      ? layoutItem.col + i
      : layoutItem.col;

    const cell = grid.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
    if (!cell) continue;

    const letter = answerArr[i] || "";

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø¨ÙƒØ© ÙÙ‚Ø·
    cell.textContent = letter;
    cell.dataset.letter = letter;

    // ØªØ­Ø¯ÙŠØ« ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
    if (input[i]) input[i].textContent = letter;
  }
}
/* ===== DATA: Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø© ===== */

const stages = [
  // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1 (Ù…Ø­ÙÙˆØ¸Ø© ÙƒÙ…Ø§ Ù‡ÙŠ)
  {
    name: "Ù…Ø±Ø­Ù„Ø© âµ£ - 1",
    grid: { cols: 7, rows: 7 },
    layout: [
      { q: 0, col: 0, row: 0, dir: "vertical", length: 3 },
      { q: 1, col: 3, row: 0, dir: "vertical", length: 3 },
      { q: 2, col: 0, row: 5, dir: "vertical", length: 3 },
      { q: 3, col: 6, row: 0, dir: "vertical", length: 3 },
      { q: 4, col: 6, row: 5, dir: "vertical", length: 3 },
      { q: 5, col: 3, row: 0, dir: "vertical", length: 7 },
      { q: 6, col: 0, row: 2, dir: "horizontal", length: 7 },
      { q: 7, col: 0, row: 5, dir: "horizontal", length: 7 }
    ],
    qs: [
      { a: "â´°âµâµ‰", text: { ar: "ÙƒÙ„Ù…Ø© Ø¹Ù…ÙˆØ¯ÙŠØ© 1", en: "Vertical 1", am: "â´°âµâµ‰" } },
      { a: "â´·âµ“â´³", text: { ar: "ÙƒÙ„Ù…Ø© Ø¹Ù…ÙˆØ¯ÙŠØ© 2", en: "Vertical 2", am: "â´·âµ“â´³" } },
      { a: "â´³âµ‰â´³", text: { ar: "ÙƒÙ„Ù…Ø© Ø¹Ù…ÙˆØ¯ÙŠØ© 3", en: "Vertical 3", am: "â´³âµ‰â´³" } },
      { a: "âµ‰âµâµ™", text: { ar: "ÙƒÙ„Ù…Ø© Ø¹Ù…ÙˆØ¯ÙŠØ© 4", en: "Vertical 4", am: "âµ‰âµâµ™" } },
      { a: "â´·â´°âµ£", text: { ar: "ÙƒÙ„Ù…Ø© Ø¹Ù…ÙˆØ¯ÙŠØ© 5", en: "Vertical 5", am: "â´·â´°âµ£" } },
      { a: "â´°â´±â´³â´·â´»â´½â´³", text: { ar: "Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆØ³Ø·", en: "Middle column", am: "â´°â´±â´³â´·â´»â´½â´³" } },
      { a: "âµ‰âµâ´°â´³â´·âµ·âµ™", text: { ar: "Ø£ÙÙ‚ÙŠØ© 1", en: "Horizontal 1", am: "âµ‰âµâ´°â´³â´·âµ·âµ™" } },
      { a: "â´³â´°âµâ´½âµ‰âµ”â´·", text: { ar: "Ø£ÙÙ‚ÙŠØ© 2", en: "Horizontal 2", am: "â´³â´°âµâ´½âµ‰âµ”â´·" } }
    ]
  },

  // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2
  {
    name: "Ù…Ø±Ø­Ù„Ø© âµ£ - 2",
    grid: { cols: 7, rows: 7 },
    layout: [
      { q: 0, col: 0, row: 0, dir: "vertical", length: 3 },
      { q: 1, col: 3, row: 0, dir: "vertical", length: 3 },
      { q: 2, col: 0, row: 5, dir: "vertical", length: 3 },
      { q: 3, col: 6, row: 0, dir: "vertical", length: 3 },
      { q: 4, col: 6, row: 5, dir: "vertical", length: 3 },
      { q: 5, col: 3, row: 0, dir: "vertical", length: 7 },
      { q: 6, col: 0, row: 2, dir: "horizontal", length: 7 },
      { q: 7, col: 0, row: 5, dir: "horizontal", length: 7 }
    ],
    qs: [
      { a: "â´°âµâ´±", text: { ar: "Vertical 1", en: "Vertical 1", am: "â´°âµâ´±" } },
      { a: "â´·â´°â´½", text: { ar: "Vertical 2", en: "Vertical 2", am: "â´·â´°â´½" } },
      { a: "â´³âµ‰â´³", text: { ar: "Vertical 3", en: "Vertical 3", am: "â´³âµ‰â´³" } },
      { a: "âµ‰âµâµ™", text: { ar: "Vertical 4", en: "Vertical 4", am: "âµ‰âµâµ™" } },
      { a: "â´·â´°âµ£", text: { ar: "Vertical 5", en: "Vertical 5", am: "â´·â´°âµ£" } },
      { a: "â´°â´±â´·â´·â´»â´¼â´³", text: { ar: "Middle column", en: "Middle column", am: "â´°â´±â´·â´·â´»â´¼â´³" } },
      { a: "â´±âµâ´°â´·â´³âµ·âµ™", text: { ar: "Horizontal 1", en: "Horizontal 1", am: "â´±âµâ´°â´·â´³âµ·âµ™" } },
      { a: "â´³â´°âµâ´¼âµ‰âµ”â´·", text: { ar: "Horizontal 2", en: "Horizontal 2", am: "â´³â´°âµâ´¼âµ‰âµ”â´·" } }
    ]
  },

  // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3
  {
    name: "Ù…Ø±Ø­Ù„Ø© âµ£ - 3",
    grid: { cols: 7, rows: 7 },
    layout: [
      { q: 0, col: 0, row: 0, dir: "vertical", length: 3 },
      { q: 1, col: 3, row: 0, dir: "vertical", length: 3 },
      { q: 2, col: 0, row: 5, dir: "vertical", length: 3 },
      { q: 3, col: 6, row: 0, dir: "vertical", length: 3 },
      { q: 4, col: 6, row: 5, dir: "vertical", length: 3 },
      { q: 5, col: 3, row: 0, dir: "vertical", length: 7 },
      { q: 6, col: 0, row: 2, dir: "horizontal", length: 7 },
      { q: 7, col: 0, row: 5, dir: "horizontal", length: 7 }
    ],
    qs: [
      { a: "â´°âµâ´·", text: { ar: "Vertical 1", en: "Vertical 1", am: "â´°âµâ´·" } },
      { a: "â´·â´°âµƒ", text: { ar: "Vertical 2", en: "Vertical 2", am: "â´·â´°âµƒ" } },
      { a: "â´³âµ‰â´³", text: { ar: "Vertical 3", en: "Vertical 3", am: "â´³âµ‰â´³" } },
      { a: "âµ‰âµâµ™", text: { ar: "Vertical 4", en: "Vertical 4", am: "âµ‰âµâµ™" } },
      { a: "â´·â´°âµ£", text: { ar: "Vertical 5", en: "Vertical 5", am: "â´·â´°âµ£" } },
      { a: "â´°â´±â´³â´·â´»â´¿â´³", text: { ar: "Middle column", en: "Middle column", am: "â´°â´±â´³â´·â´»â´¿â´³" } },
      { a: "â´±âµâ´°â´¶â´³âµ·âµ™", text: { ar: "Horizontal 1", en: "Horizontal 1", am: "â´±âµâ´°â´¶â´³âµ·âµ™" } },
      { a: "â´³â´°âµâ´¼âµ‰âµ”â´·", text: { ar: "Horizontal 2", en: "Horizontal 2", am: "â´³â´°âµâ´¼âµ‰âµ”â´·" } }
    ]
  },

  // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4
  {
    name: "Ù…Ø±Ø­Ù„Ø© âµ£ - 4",
    grid: { cols: 7, rows: 7 },
    layout: [
      { q: 0, col: 0, row: 0, dir: "vertical", length: 3 },
      { q: 1, col: 3, row: 0, dir: "vertical", length: 3 },
      { q: 2, col: 0, row: 5, dir: "vertical", length: 3 },
      { q: 3, col: 6, row: 0, dir: "vertical", length: 3 },
      { q: 4, col: 6, row: 5, dir: "vertical", length: 3 },
      { q: 5, col: 3, row: 0, dir: "vertical", length: 7 },
      { q: 6, col: 0, row: 2, dir: "horizontal", length: 7 },
      { q: 7, col: 0, row: 5, dir: "horizontal", length: 7 }
    ],
    qs: [
      { a: "â´°âµâµ‡", text: { ar: "Vertical 1", en: "Vertical 1", am: "â´°âµâµ‡" } },
      { a: "â´·â´°âµ‰", text: { ar: "Vertical 2", en: "Vertical 2", am: "â´·â´°âµ‰" } },
      { a: "â´³âµ‰â´³", text: { ar: "Vertical 3", en: "Vertical 3", am: "â´³âµ‰â´³" } },
      { a: "âµ‰âµâµ™", text: { ar: "Vertical 4", en: "Vertical 4", am: "âµ‰âµâµ™" } },
      { a: "â´·â´°âµ£", text: { ar: "Vertical 5", en: "Vertical 5", am: "â´·â´°âµ£" } },
      { a: "â´°â´±â´³â´·â´»âµ€â´³", text: { ar: "Middle column", en: "Middle column", am: "â´°â´±â´³â´·â´»âµ€â´³" } },
      { a: "â´±âµâ´°â´·â´³âµ¸âµ™", text: { ar: "Horizontal 1", en: "Horizontal 1", am: "â´±âµâ´°â´·â´³âµ¸âµ™" } },
      { a: "â´³â´°âµâ´¼âµ‰âµ”â´·", text: { ar: "Horizontal 2", en: "Horizontal 2", am: "â´³â´°âµâ´¼âµ‰âµ”â´·" } }
    ]
  }
];

/* ===== START QUESTION ===== */
function startQuestion(){
  const L = stages[stage].qs[q];
  levelTitle.textContent = stages[stage].name;

  // ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„
  if(L.img){ questionImg.src = L.img; questionImg.style.display="block"; }
  else questionImg.style.display="none";

  // Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„
  if(L.text && L.text[currentLang]){ questionText.textContent = L.text[currentLang]; questionText.style.display="block"; }
  else questionText.style.display="none";

  // ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
  boxes.innerHTML = ""; input = [];
  for(let ch of L.a){ const b = document.createElement("div"); b.className = "answer-box"; boxes.appendChild(b); }

  // Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­/Ø§Ù„Ø¹Ø¬Ù„Ø©
  renderBoard(L);
  hintCount.textContent = hintsLeft;
}

/* ===== BOARD: KEYBOARD & WHEEL ===== */
function makeKey(ch){
  const k = document.createElement("div");
  k.className="key"; k.textContent=ch; k.dataset.ch=ch;
  return k;
}

function pick(el,L){
  if(el.classList.contains("used") || el.classList.contains("locked")) return;
  el.classList.add("used");
  input.push(el);
  if(vibeOn && navigator.vibrate) navigator.vibrate(20);
  refresh();
  if(input.length===L.a.length) check(L);
}

function removeLast(){
  if(!input.length) return;
  const last = input.pop(); if(last) last.classList.remove("used"); refresh();
}

function renderBoard(L){
  keyboard.innerHTML=""; wheel.innerHTML="";
  keyboard.style.display="none"; wheel.style.display="none";

  const letters=[...L.a].sort(()=>Math.random()-.5);

  if(L.shape==="circle"){
    wheel.style.display="block";
    const r=110,c=130;
    letters.forEach((ch,j)=>{
      const a=2*Math.PI*j/letters.length;
      const k=makeKey(ch);
      k.style.left = c+r*Math.cos(a)-26+"px";
      k.style.top  = c+r*Math.sin(a)-26+"px";
      wheel.appendChild(k);
    });
  } else {
    keyboard.style.display="grid";
    keyboard.className=L.shape==="hexagon"?"hexagon":"keyboard";
    letters.forEach(ch=>{
      const k=makeKey(ch);
      k.addEventListener("click",()=>pick(k,L));
      if(L.shape==="hexagon") k.classList.add("hex-cell");
      keyboard.appendChild(k);
    });
    const del=document.createElement("div"); del.className="delete"; del.textContent="âŒ«"; del.onclick=removeLast;
    keyboard.appendChild(del);
  }
}

/* ===== DRAG FOR CIRCLE ===== */
wheel.addEventListener("pointerdown", e=>{
  const L=stages[stage].qs[q]; if(L.shape!=="circle") return; input=[]; drag=true; dragPick(e,L);
});
wheel.addEventListener("pointermove", e=>{ if(!drag) return; const L=stages[stage].qs[q]; dragPick(e,L); });
document.addEventListener("pointerup", ()=>{
  if(!drag) return; drag=false;
  const L=stages[stage].qs[q];
  if(input.length!==L.a.length) setTimeout(()=>startQuestion(),100);
  else check(L);
});
function dragPick(e,L){
  const el=document.elementFromPoint(e.clientX,e.clientY);
  if(el && el.classList.contains("key")) pick(el,L);
}

/* ===== REFRESH ANSWER BOXES ===== */
function refresh(){
  const stageCard = mapGrid.children[stage];
  if (!stageCard) return;

  const grid = stageCard.querySelector('.stage-grid');

  document.querySelectorAll(".answer-box").forEach((box,i)=>{

    // Ù‚Ø±Ø§Ø¡Ø© Ø­Ø±Ù Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ© Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    let letterFromGrid = "";
    if (grid) {
      const cell = grid.querySelector(`.cell[data-q='${q}'][data-pos='${i}']`);
      if (cell && cell.dataset.letter) {
        letterFromGrid = cell.dataset.letter;
      }
    }

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø­Ø±Ù Ù†Ø£Ø®Ø° Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
    box.textContent = letterFromGrid || input[i]?.dataset?.ch || "";
    box.className = "answer-box";
  });
}
/* ===== CHECK ANSWER ===== */
function check(L){
  const answer = input.map(k => k.dataset.ch).join("");

  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©
  if(answer !== L.a){
    document.querySelectorAll(".answer-box").forEach(b => b.classList.add("bad"));
    setTimeout(() => refresh(), 500);
    return;
  }

  // Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©
  clap();
  hintsUsed = input.length;
  stars[stage] = Math.max(stars[stage] || 0, 3 - hintsUsed);
  localStorage.setItem("amazighStars", JSON.stringify(stars));

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
  const stageCard = mapGrid.children[stage];
  if(stageCard){
    const grid = stageCard.querySelector('.stage-grid');
    const layoutItem = stages[stage].layout.find(l => l.q === q);

    if(grid && layoutItem){
      for(let i = 0; i < layoutItem.length; i++){
        const r = layoutItem.dir === "horizontal" ? layoutItem.row : layoutItem.row + i;
        const c = layoutItem.dir === "horizontal" ? layoutItem.col + i : layoutItem.col;

        const cell = grid.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
        if(cell){
          cell.textContent = answer[i];
          cell.dataset.letter = answer[i];
          cell.dataset.pos = i; // Ù…Ù‡Ù…: Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø±Ù Ø¶Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø©
        }
      }
    }

    // ØªØ­Ø¯ÙŠØ« ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
    document.querySelectorAll(".answer-box").forEach((box, i) => {
      box.textContent = answer[i];
      box.classList.add("ok");
    });
  }

  // Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
  q++;
  if(q < stages[stage].qs.length){
    setTimeout(startQuestion, 800);
  } else {
    if(stage === unlocked){
      unlocked++;
      localStorage.setItem("amazighUnlocked", unlocked);
    }

    if(stage + 1 < stages.length){
      stageOverlay.classList.add("active");
      nextStageBtn.onclick = () => {
        stageOverlay.classList.remove("active");
        startStage(stage + 1);
      };
    } else {
      celebrate(true);
      finalOverlay.classList.add("active");
    }
  }
}

/* ===== CELEBRATION ===== */
const symbols=["ğŸ¤—","ğŸ¤©","ğŸ‘","ğŸ‘","ğŸ‘","ayuuz","â´°âµ¢âµ¢âµ“âµ£","ğŸŒ¸","ğŸŒº","â¤ï¸","ğŸ’–","ğŸ’","âµ£","âµ‰","âµœ","â´°","ğŸŒ¸","ğŸŒº","ğŸŒ¹","ğŸƒ","ğŸŒ·","ğŸŒ¼","ğŸŒ»","âš˜","ğŸˆ","ğŸ’µ","ğŸ’¶","ğŸ’¸","âœ”","âœ…"];

function celebrate(final=false){
  clap();
  for(let i=0;i<25;i++){
    const c=document.createElement("div");
    c.className="confetti";
    c.textContent=symbols[Math.floor(Math.random()*symbols.length)];
    c.style.left=Math.random()*100+"vw";
    c.style.animationDuration=2+Math.random()*2+"s";
    document.body.appendChild(c);
    setTimeout(()=>c.remove(),4000);
  }
}


/* ===== STAGE GRID ===== */

function createStageGrid(rows = 2, cols = 2) {
  const grid = document.getElementById('stageGrid');
  if (!grid) return;

  grid.innerHTML = '';

  for (let i = 0; i < rows * cols; i++) {
    const cell = document.createElement('div');
    cell.className = 'cell';
    grid.appendChild(cell);
  }
}

/* ØªØ´ØºÙŠÙ„ Ø§Ù„Ø´Ø¨ÙƒØ© Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø±Ø­Ù„Ø© */
createStageGrid(2,2);
</script>
</body>
</html>
