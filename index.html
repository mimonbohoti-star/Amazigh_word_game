<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>âµ£ Ù„Ø¹Ø¨Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø£Ù…Ø§Ø²ÙŠØºÙŠØ©</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{--accent:#facc15}
*{box-sizing:border-box}
body{
 margin:0;font-family:sans-serif;
 background:radial-gradient(circle at top,#1e293b,#020617);
 color:#fff;display:flex;justify-content:center;align-items:center;
 min-height:100vh;overflow:hidden;
}
.card{
 width:95%;max-width:420px;background:#020617;border-radius:26px;
 padding:20px;
 box-shadow:0 0 0 2px var(--accent),0 30px 60px rgba(0,0,0,.7);
 position:relative;z-index:2;
}
h1{text-align:center;color:var(--accent);margin:6px 0}
img{width:100%;border-radius:16px;margin:10px 0}

.section{display:none}
.section.active{display:block}

.btn{
 width:100%;min-height:52px;margin:8px 0;border:none;border-radius:16px;
 font-size:18px;font-weight:700;cursor:pointer
}
.btn-main{background:var(--accent);color:#000}
.btn-back{background:#0f172a;color:#fff;border:1px solid #334155}

.sound-btn{
 position:absolute;top:14px;left:14px;
 width:44px;height:44px;border-radius:50%;
 background:#0f172a;border:1px solid #334155;
 color:#fff;font-size:20px;cursor:pointer;
}

.answer-boxes{
 display:flex;justify-content:center;gap:8px;margin:12px 0;
 direction:ltr;
}
.answer-box{
 width:44px;height:44px;border-radius:10px;background:#fff;color:#000;
 display:flex;align-items:center;justify-content:center;font-size:22px
}
.answer-box.ok{background:#22c55e}
.answer-box.bad{background:#ef4444;color:#fff}

.keyboard{
 display:grid;grid-template-columns:repeat(4,1fr);gap:10px;
}
.triangle{
 display:grid;grid-template-columns:repeat(3,1fr);gap:10px;
 justify-items:center;
}
.key{
 background:#1e293b;padding:14px;border-radius:14px;
 text-align:center;font-size:22px;font-weight:bold;
 user-select:none;cursor:pointer;
}
.key.used{opacity:.25;pointer-events:none}

.wheel{
 width:260px;height:260px;margin:16px auto;
 border-radius:50%;border:3px solid var(--accent);
 position:relative;
}
.wheel .key{
 width:52px;height:52px;border-radius:50%;
 background:var(--accent);color:#000;
 position:absolute;display:flex;
 align-items:center;justify-content:center;
}

.delete{
 background:#0f172a;border:1px solid #334155;
 border-radius:14px;padding:14px;
 font-size:20px;font-weight:bold;cursor:pointer;
}

.overlay{
 position:fixed;inset:0;background:rgba(0,0,0,.8);
 display:none;justify-content:center;align-items:center;
 z-index:5;
}
.overlay.active{display:flex}
.win{
 background:#020617;padding:26px;border-radius:22px;
 box-shadow:0 0 60px var(--accent);
 text-align:center;
 animation:pulse .6s infinite alternate;
}
@keyframes pulse{
 from{box-shadow:0 0 20px var(--accent)}
 to{box-shadow:0 0 90px #fff}
}

.confetti{
 position:fixed;top:-20px;
 font-size:26px;
 animation:fall linear forwards;
 pointer-events:none;
 z-index:10;
}
@keyframes fall{
 to{transform:translateY(120vh) rotate(360deg);opacity:0}
}
</style>
</head>

<body>

<div class="card">
<button class="sound-btn" id="soundBtn">ğŸ”Š</button>

<div id="menu" class="section active">
 <h1>âµ£ Ù„Ø¹Ø¨Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø£Ù…Ø§Ø²ÙŠØºÙŠØ©</h1>
 <button class="btn btn-main" onclick="openMap()">â–¶ï¸ Ø¨Ø¯Ø¡</button>
</div>

<div id="map" class="section">
 <h1>â­ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</h1>
 <div id="mapGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px"></div>
 <button class="btn btn-back" onclick="show('menu')">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
</div>

<div id="game" class="section">
 <h1 id="levelTitle"></h1>
 <img id="questionImg">
 <div class="answer-boxes" id="boxes"></div>
 <div id="wheel" class="wheel"></div>
 <div id="keyboard" class="keyboard"></div>
 <button class="btn btn-back" onclick="show('map')">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
</div>
</div>

<div id="overlay" class="overlay">
 <div class="win"><h2>ğŸ”¥ Ø£Ø­Ø³Ù†Øª ğŸ”¥</h2></div>
</div>

<script>
/* ===== SOUND (FIXED) ===== */
let soundOn=true;
let ctx=null;
const soundBtn=document.getElementById("soundBtn");

function initAudio(){
 if(!ctx){
  ctx=new (window.AudioContext||window.webkitAudioContext)();
 }
 if(ctx.state==="suspended") ctx.resume();
}

function clap(){
 if(!soundOn) return;
 initAudio();
 for(let i=0;i<8;i++){
  const o=ctx.createOscillator();
  const g=ctx.createGain();
  o.type="square";
  o.frequency.value=180+Math.random()*500;
  g.gain.setValueAtTime(0.6,ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.18);
  o.connect(g).connect(ctx.destination);
  o.start();
  o.stop(ctx.currentTime+0.18);
 }
 if(navigator.vibrate) navigator.vibrate([100,50,100]);
}

soundBtn.onclick=()=>{
 soundOn=!soundOn;
 soundBtn.textContent=soundOn?"ğŸ”Š":"ğŸ”‡";
 if(soundOn) initAudio();
};

/* ===== DATA ===== */
const stages=[
 {qs:[
  {a:"âµœâ´°â´¼âµ“âµ¢âµœ",shape:"circle",img:"sun.jpg"},
  {a:"â´°âµ¢âµ“âµ”",shape:"triangle",img:"moon.jpg"},
  {a:"âµ‰âµœâµ”â´°âµ",shape:"grid",img:"stars.jpg"}
 ]},
 {qs:[
  {a:"â´°â´·âµ”â´°âµ”",shape:"circle",img:"mountain.jpg"},
  {a:"â´°âµ™âµ‰â´¼",shape:"triangle",img:"river.jpg"},
  {a:"âµœâ´°âµâ´°âµ£âµ‰âµ”âµœ",shape:"grid",img:"images/flag.jpg"}
 ]},
 {qs:[
  {a:"â´°âµ£âµ£âµ“",shape:"circle",img:"flower.jpg"},
  {a:"â´°âµ£â´³â´³âµ¯â´°âµ–",shape:"triangle",img:"cactus.jpg"},
  {a:"â´°âµ£â´³âµ£â´°âµ¡",shape:"grid",img:"flowers.jpg"}
 ]},
 {qs:[
  {a:"â´°âµâ´°âµ",shape:"circle",img:"river.jpg"},
  {a:"â´°â´¼â´°âµ™",shape:"triangle",img:"insect.jpg"},
  {a:"â´°âµâµ£âµ£âµ“âµ–",shape:"grid",img:"sun.jpg"}
 ]},
 {qs:[
  {a:"â´°â´½â´°âµ",shape:"circle",img:"mountain.jpg"},
  {a:"â´°âµâµ£â´°âµ”",shape:"triangle",img:"rain.jpg"},
  {a:"â´°â´¼âµ“âµ™",shape:"grid",img:"flower.jpg"}
 ]}
];

let unlocked=+localStorage.getItem("amazighUnlocked")||0;
let stage=0,q=0,input=[],drag=false;
const symbols=["ğŸŒ¸","ğŸŒº","ğŸŒ¹","â¤ï¸","ğŸ’–","ğŸ’","âµ£","âµ‰","âµœ","â´°"];

function show(id){
 document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
 document.getElementById(id).classList.add("active");
}

function openMap(){
 mapGrid.innerHTML="";
 stages.forEach((_,i)=>{
  const d=document.createElement("div");
  d.className="key"+(i>unlocked?" used":"");
  d.textContent="Ù…Ø±Ø­Ù„Ø© "+(i+1);
  if(i<=unlocked)d.onclick=()=>startStage(i);
  mapGrid.appendChild(d);
 });
 show("map");
}

function startStage(i){ stage=i; q=0; startQuestion(); }

function startQuestion(){
 input=[];
 const L=stages[stage].qs[q];
 levelTitle.textContent=`Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${stage+1} â€” Ø³Ø¤Ø§Ù„ ${q+1}/3`;
 questionImg.src=L.img;
 renderBoxes(L); renderBoard(L); show("game");
}

function renderBoxes(L){
 boxes.innerHTML="";
 for(let i=0;i<L.a.length;i++) boxes.innerHTML+=`<div class="answer-box"></div>`;
}

function renderBoard(L){
 keyboard.innerHTML=""; wheel.innerHTML="";
 keyboard.style.display="none"; wheel.style.display="none";
 const letters=[...L.a].sort(()=>Math.random()-.5);

 if(L.shape==="circle"){
  wheel.style.display="block";
  const r=110,c=130;
  letters.forEach((ch,j)=>{
   const a=2*Math.PI*j/letters.length;
   const k=makeKey(ch);
   k.style.left=c+r*Math.cos(a)-26+"px";
   k.style.top =c+r*Math.sin(a)-26+"px";
   wheel.appendChild(k);
  });
 }else{
  keyboard.style.display="grid";
  if(L.shape==="triangle") keyboard.className="triangle";
  letters.forEach(ch=>{
   const k=makeKey(ch); k.onclick=()=>pick(k,L); keyboard.appendChild(k);
  });
  const del=document.createElement("div");
  del.className="delete"; del.textContent="âŒ«"; del.onclick=removeLast;
  keyboard.appendChild(del);
 }
}

function makeKey(ch){
 const k=document.createElement("div");
 k.className="key"; k.textContent=ch; k.dataset.ch=ch;
 return k;
}

function pick(el,L){
 if(el.classList.contains("used"))return;
 if(input.length>=L.a.length)return;
 el.classList.add("used"); input.push(el); refresh();
 if(input.length===L.a.length && L.shape!=="circle") check(L);
}

function removeLast(){
 if(!input.length)return;
 const last=input.pop(); if(last) last.classList.remove("used"); refresh();
}

wheel.addEventListener("pointerdown",e=>{
 const L=stages[stage].qs[q];
 if(L.shape!=="circle")return; drag=true; dragPick(e,L);
});
wheel.addEventListener("pointermove",e=>{ if(drag) dragPick(e,stages[stage].qs[q]); });
document.addEventListener("pointerup",()=>{ if(drag){drag=false; check(stages[stage].qs[q]);} });

function dragPick(e,L){
 const el=document.elementFromPoint(e.clientX,e.clientY);
 if(!el||!el.classList.contains("key"))return; pick(el,L);
}

function refresh(){
 document.querySelectorAll(".answer-box").forEach((b,i)=>{
  b.textContent=input[i]?.dataset.ch||""; b.className="answer-box";
 });
}

function celebrate(){
 clap();
 for(let i=0;i<40;i++){
  const c=document.createElement("div");
  c.className="confetti";
  c.textContent=symbols[Math.floor(Math.random()*symbols.length)];
  c.style.left=Math.random()*100+"vw";
  c.style.animationDuration=2+Math.random()*2+"s";
  document.body.appendChild(c);
  setTimeout(()=>c.remove(),4000);
 }
}

function check(L){
 if(input.length!==L.a.length)return;
 const ok=input.map(k=>k.dataset.ch).join("")===L.a;
 document.querySelectorAll(".answer-box").forEach(b=>b.classList.add(ok?"ok":"bad"));

 if(ok){
  celebrate(); overlay.classList.add("active");
  setTimeout(()=>{
   overlay.classList.remove("active");
   q++;
   if(q<3) startQuestion();
   else{
    if(stage===unlocked){ unlocked++; localStorage.setItem("amazighUnlocked",unlocked); }
    show("map");
   }
  },1200);
 }else{
  setTimeout(()=>{ startQuestion(); },700);
 }
}
</script>
</body>
</html>
